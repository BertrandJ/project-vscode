<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PixelPulse Players Map</title>
    <link rel="stylesheet" href="styles.css">
    <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-sA+e2atLYHsk/gsJvMxXTJLzYtC+jHgGUX2R0C2jU14="
        crossorigin=""
    >
    <script
        src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-o9N1j7kP5Sx3G2oEdl7DlsQRRXLMFa9YwpuGH2T6IPw="
        crossorigin=""
    ></script>
</head>
<body class="map-page">
    <header class="hero hero-compact">
        <div class="overlay"></div>
        <nav class="top-nav">
            <span class="logo">PixelPulse</span>
            <ul class="nav-links">
                <li><a href="index.html#store">Store</a></li>
                <li><a href="index.html#collections">Collections</a></li>
                <li><a href="famous-games.html">Famous Games</a></li>
                <li><a class="active" href="map.html">Players Map</a></li>
                <li><a href="team.html">Team</a></li>
                <li><a href="index.html#about">About</a></li>
                <li><a href="index.html#support">Support</a></li>
            </ul>
            <a class="cta" href="index.html#store">Shop Now</a>
        </nav>
        <div class="hero-content">
            <h1>Global Player Heatmap</h1>
            <p>Interact with our live community map to see where PixelPulse players are logging in from around the world.</p>
        </div>
    </header>

    <main class="map-main">
        <section class="map-section">
            <div id="players-map" role="region" aria-label="Interactive PixelPulse player distribution map"></div>
            <aside class="map-sidebar">
                <h2>Regional Highlights</h2>
                <p class="map-sidebar-intro">Hover over any country to reveal its active players and click to zoom in for a closer look.</p>
                <dl class="map-stats">
                    <div>
                        <dt>Top Community</dt>
                        <dd>United States – 164,000 players</dd>
                    </div>
                    <div>
                        <dt>Fastest Growth</dt>
                        <dd>Brazil – up 18% month over month</dd>
                    </div>
                    <div>
                        <dt>Esports Hubs</dt>
                        <dd>South Korea · Germany · Japan</dd>
                    </div>
                    <div>
                        <dt>New Hotspot</dt>
                        <dd>Nigeria – 17,000 competitive players</dd>
                    </div>
                </dl>
                <div class="map-controls">
                    <button class="btn small map-btn" data-lat="20" data-lng="0" data-zoom="2">Reset View</button>
                    <button class="btn small map-btn" data-lat="40" data-lng="-100" data-zoom="4">North America</button>
                    <button class="btn small map-btn" data-lat="10" data-lng="-55" data-zoom="4">South America</button>
                    <button class="btn small map-btn" data-lat="52" data-lng="10" data-zoom="4">Europe</button>
                    <button class="btn small map-btn" data-lat="22" data-lng="90" data-zoom="4">Asia</button>
                </div>
            </aside>
        </section>
    </main>

    <footer class="footer">
        <div>
            <h4>Need Help?</h4>
            <p>Email <a href="mailto:support@pixelpulse.games">support@pixelpulse.games</a> or visit our FAQ.</p>
        </div>
        <div class="social">
            <a href="#">Instagram</a>
            <a href="#">Twitter</a>
            <a href="#">Discord</a>
        </div>
        <p class="copyright">© 2025 PixelPulse Games. All rights reserved.</p>
    </footer>

    <script>
        function initMap() {
            if (typeof L === 'undefined') {
                setTimeout(initMap, 50);
                return;
            }
            const playerTotals = {
                'United States of America': 164000,
                'Canada': 42000,
                'Mexico': 38000,
                'Brazil': 91000,
                'Argentina': 27000,
                'Chile': 16000,
                'United Kingdom': 56000,
                'France': 49000,
                'Germany': 73000,
                'Spain': 31000,
                'Italy': 36000,
                'Netherlands': 21000,
                'Sweden': 19000,
                'Norway': 12000,
                'Finland': 14000,
                'Poland': 28000,
                'Turkey': 33000,
                'United Arab Emirates': 9000,
                'South Africa': 15000,
                'Nigeria': 17000,
                'Egypt': 21000,
                'India': 82000,
                'China': 132000,
                'Japan': 76000,
                'South Korea': 68000,
                'Singapore': 15000,
                'Australia': 25000,
                'New Zealand': 9000
            };

            const getColor = total => {
                if (total > 120000) return '#ef476f';
                if (total > 90000) return '#f78c6b';
                if (total > 60000) return '#ffd166';
                if (total > 35000) return '#06d6a0';
                if (total > 15000) return '#118ab2';
                if (total > 5000) return '#073b4c';
                return '#2f2f48';
            };

            const mapContainer = document.getElementById('players-map');
            if (!mapContainer) {
                console.error('Map container not found');
                return;
            }

            const map = L.map('players-map', {
                worldCopyJump: true,
                maxBoundsViscosity: 1
            }).setView([20, 0], 2);
            map.setMaxBounds([
                [-90, -190],
                [90, 190]
            ]);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            // Invalidate map size after a short delay to ensure container is fully rendered
            setTimeout(() => {
                map.invalidateSize();
            }, 100);

            const info = L.control({ position: 'topright' });
            info.onAdd = function () {
                this._div = L.DomUtil.create('div', 'map-info');
                this.update();
                return this._div;
            };
            info.update = function (props) {
                if (!props) {
                    this._div.innerHTML = '<strong>Player Spotlight</strong><br>Hover over a country';
                    return;
                }
                const country = props.name;
                const total = playerTotals[country];
                this._div.innerHTML = total
                    ? `<strong>${country}</strong><br>${total.toLocaleString()} players`
                    : `<strong>${country}</strong><br>No active data yet`;
            };
            info.addTo(map);

            const legend = L.control({ position: 'bottomright' });
            legend.onAdd = function () {
                const div = L.DomUtil.create('div', 'map-legend');
                const ranges = [
                    { min: 0, max: 5000 },
                    { min: 5001, max: 15000 },
                    { min: 15001, max: 35000 },
                    { min: 35001, max: 60000 },
                    { min: 60001, max: 90000 },
                    { min: 90001, max: 120000 },
                    { min: 120001, max: null }
                ];
                div.innerHTML = '<h4>Players</h4>';
                ranges.forEach(range => {
                    const value = (range.min + (range.max || range.min)) / 2;
                    const label = range.max
                        ? `${range.min.toLocaleString()}–${range.max.toLocaleString()}`
                        : `${range.min.toLocaleString()}+`;
                    div.innerHTML += `<span><i style="background:${getColor(value)}"></i>${label}</span>`;
                });
                return div;
            };
            legend.addTo(map);

            let geojsonLayer;

            const handleHover = event => {
                const layer = event.target;
                layer.setStyle({
                    weight: 2,
                    color: '#ffffff',
                    dashArray: '',
                    fillOpacity: 0.85
                });
                if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
                    layer.bringToFront();
                }
                info.update(layer.feature.properties);
            };

            const resetHover = event => {
                geojsonLayer.resetStyle(event.target);
                info.update();
            };

            const zoomToFeature = event => {
                map.fitBounds(event.target.getBounds());
            };

            // Try multiple GeoJSON sources for better reliability
            const geojsonSources = [
                'https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson',
                'https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json'
            ];

            function loadGeoJSON(sourceIndex = 0) {
                if (sourceIndex >= geojsonSources.length) {
                    throw new Error('All GeoJSON sources failed');
                }
                
                fetch(geojsonSources[sourceIndex])
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Failed to load map data');
                        }
                        return response.json();
                    })
                    .then(data => {
                    geojsonLayer = L.geoJSON(data, {
                        style: feature => {
                            const countryName = feature.properties.name;
                            const total = playerTotals[countryName] || 0;
                            return {
                                weight: 1,
                                opacity: 0.75,
                                color: '#1f2937',
                                dashArray: '3',
                                fillOpacity: 0.7,
                                fillColor: getColor(total)
                            };
                        },
                        onEachFeature: (feature, layer) => {
                            layer.on({
                                mouseover: handleHover,
                                mouseout: resetHover,
                                click: zoomToFeature
                            });
                            const countryName = feature.properties.name;
                            const total = playerTotals[countryName];
                            layer.bindTooltip(
                                total
                                    ? `${countryName}: ${total.toLocaleString()} players`
                                    : `${countryName}: No data`,
                                { sticky: true }
                            );
                        }
                    }).addTo(map);
                    })
                    .catch(error => {
                        // Try next source if available
                        if (sourceIndex + 1 < geojsonSources.length) {
                            loadGeoJSON(sourceIndex + 1);
                        } else {
                            // All sources failed
                            const errorBanner = document.createElement('div');
                            errorBanner.className = 'map-error';
                            errorBanner.textContent = 'Unable to load the world map right now. Please check your connection and reload.';
                            document.querySelector('.map-section').appendChild(errorBanner);
                            console.error('Failed to load GeoJSON:', error);
                        }
                    });
            }
            
            loadGeoJSON();

            document.querySelectorAll('.map-btn').forEach(button => {
                button.addEventListener('click', event => {
                    const target = event.currentTarget;
                    const lat = Number(target.dataset.lat);
                    const lng = Number(target.dataset.lng);
                    const zoom = Number(target.dataset.zoom);
                    map.flyTo([lat, lng], zoom, { duration: 0.8 });
                });
            });
        }

        // Wait for both DOM and Leaflet to be ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initMap);
        } else {
            initMap();
        }
    </script>
</body>
</html>
